services:
  isaac-sim:
    # 1. 커스텀 이미지 빌드 (sudo 사용 가능 버전)
    build:
      context: .
      dockerfile: Dockerfile
    image: ghcr.io/itschurry/isaac-sim-zed-5.1:5.1.0
    container_name: isaac-sim-custom

    # 2. 실행 모드 및 네트워크
    command: bash
    stdin_open: true # -i
    tty: true        # -t
    privileged: true # /dev 접근 등 하드웨어 제어권
    network_mode: host
    # shm_size: '16gb' # 컨테이너에 16GB의 격리된 공유 메모리 공간 할당 (ipc: host 대체)
    ipc: host

    # 3. 환경 변수 (스크립트 내용 반영)
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - DISPLAY=:9
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=${HOME}/.Xauthority
      - TZ=Asia/Seoul
      # 호스트 라이브러리 경로는 충돌 위험이 있으나 스크립트 요청대로 유지
      - LD_LIBRARY_PATH=/usr/local/cuda/lib64:/usr/local/zed/lib:/usr/local/lib:${LD_LIBRARY_PATH}
      # NVIDIA 설정
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ROS_DOMAIN_ID=0
      - LC_ALL=C.UTF-8
      - LANG=C.UTF-8

    # 4. 볼륨 마운트
    volumes:
      # [시스템 및 GUI]
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/home/isaac-sim/.Xauthority:ro
      - /etc/localtime:/etc/localtime:ro
      # - /dev:/dev:rw # privileged:true 옵션과 중복되므로 제거 권장
      - ${HOME}/shared:/mnt/shared:rw
      
      # [Isaac Sim 데이터 & 캐시] 
      # 호스트 경로(~/docker/isaac-sim/...) : 컨테이너 경로
      - ${HOME}/docker/isaac-sim/cache/main:/isaac-sim/.cache:rw
      - ${HOME}/docker/isaac-sim/cache/computecache:/isaac-sim/.nv/ComputeCache:rw
      - ${HOME}/docker/isaac-sim/logs:/isaac-sim/.nvidia-omniverse/logs:rw
      - ${HOME}/docker/isaac-sim/config:/isaac-sim/.nvidia-omniverse/config:rw
      - ${HOME}/docker/isaac-sim/data:/isaac-sim/.local/share/ov/data:rw
      - ${HOME}/docker/isaac-sim/pkg:/isaac-sim/.local/share/ov/pkg:rw
      - ${HOME}/docker/isaac-sim/projects:/isaac-sim/projects:rw
      - ${HOME}/docker/isaac-sim/extensions:/isaac-sim/extensions:rw

    # 5. 사용자 ID 지정 (스크립트의 -u 1234:1234)
    user: "1234:1234" # isaac-sim 사용자(UID 1234)로 실행

    # 6. GPU 할당
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              # count: all
              # device_ids: ["0", "2"]
              device_ids: ["0"] # 사용할 GPU ID를 여기에 지정합니다. (예: 0번 GPU)
              capabilities: [gpu]
